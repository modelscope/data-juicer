# nested_aggregator

Aggregates nested content from multiple samples into a single summary.

This operator uses a recursive summarization approach to aggregate content from multiple samples. It processes the input text, which is split into sub-documents, and generates a summary that maintains the average length of the original documents. The aggregation is performed using an API model, guided by system prompts and templates. The operator supports retrying the API call in case of errors and allows for customization of the summarization process through various parameters. The default system prompt and templates are provided in Chinese, but they can be customized. The operator uses a Hugging Face tokenizer to handle tokenization.

èšåˆæ¥è‡ªå¤šä¸ªæ ·æœ¬çš„åµŒå¥—å†…å®¹ï¼Œç”Ÿæˆå•ä¸€æ‘˜è¦ã€‚

è¯¥ç®—å­ä½¿ç”¨é€’å½’æ±‡æ€»æ–¹æ³•æ¥èšåˆæ¥è‡ªå¤šä¸ªæ ·æœ¬çš„å†…å®¹ã€‚å®ƒå¤„ç†è¢«åˆ†å‰²æˆå­æ–‡æ¡£çš„è¾“å…¥æ–‡æœ¬ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªä¿æŒåŸå§‹æ–‡æ¡£å¹³å‡é•¿åº¦çš„æ‘˜è¦ã€‚èšåˆè¿‡ç¨‹ä½¿ç”¨ API æ¨¡å‹è¿›è¡Œï¼Œç”±ç³»ç»Ÿæç¤ºå’Œæ¨¡æ¿æŒ‡å¯¼ã€‚è¯¥ç®—å­æ”¯æŒåœ¨å‡ºé”™æ—¶é‡è¯• API è°ƒç”¨ï¼Œå¹¶å…è®¸é€šè¿‡å„ç§å‚æ•°è‡ªå®šä¹‰æ±‡æ€»è¿‡ç¨‹ã€‚é»˜è®¤çš„ç³»ç»Ÿæç¤ºå’Œæ¨¡æ¿ä»¥ä¸­æ–‡æä¾›ï¼Œä½†å¯ä»¥è‡ªå®šä¹‰ã€‚è¯¥ç®—å­ä½¿ç”¨ Hugging Face åˆ†è¯å™¨æ¥å¤„ç†åˆ†è¯ã€‚

Type ç®—å­ç±»å‹: **aggregator**

Tags æ ‡ç­¾: cpu, api, text

## ğŸ”§ Parameter Configuration å‚æ•°é…ç½®
| name å‚æ•°å | type ç±»å‹ | default é»˜è®¤å€¼ | desc è¯´æ˜ |
|--------|------|--------|------|
| `api_model` | <class 'str'> | `'gpt-4o'` | API model name. |
| `input_key` | <class 'str'> | `'event_description'` | The input key in the meta field of the samples. |
| `output_key` | <class 'str'> | `None` | The output key in the aggregation field in the |
| `max_token_num` | typing.Optional[typing.Annotated[int, Gt(gt=0)]] | `None` | The max token num of the total tokens of the |
| `api_endpoint` | typing.Optional[str] | `None` | URL endpoint for the API. |
| `response_path` | typing.Optional[str] | `None` | Path to extract content from the API response. |
| `system_prompt` | typing.Optional[str] | `None` | The system prompt. |
| `sub_doc_template` | typing.Optional[str] | `None` | The template for input text in each sample. |
| `input_template` | typing.Optional[str] | `None` | The input template. |
| `try_num` | typing.Annotated[int, Gt(gt=0)] | `3` | The number of retry attempts when there is an API |
| `model_params` | typing.Dict | `{}` | Parameters for initializing the API model. |
| `sampling_params` | typing.Dict | `{}` | Extra parameters passed to the API call. |
| `kwargs` |  | `''` | Extra keyword arguments. |

## ğŸ“Š Effect demonstration æ•ˆæœæ¼”ç¤º
### test_default_aggregator
```python
NestedAggregator(api_model='qwen2.5-72b-instruct')
```

#### ğŸ“¥ input data è¾“å…¥æ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> empty</div><div class='meta' style='margin-top:6px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; font-weight:bold; color:#555;'>__dj__meta__</td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>åå¹´å‰ï¼Œæç›¸å¤·åäº”å²æˆ˜èƒœè¥¿åŸŸå¤©é­”æˆä¸ºå¤©ä¸‹ç¬¬ä¸€é«˜æ‰‹ï¼Œåä¸ƒå²å»ºç«‹å››é¡¾é—¨ï¼ŒäºŒåå²é—®é¼æ­¦æ—ç›Ÿä¸»ï¼Œæˆä¸ºä¼ å¥‡äººç‰©ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>æœ‰äººè§†æç›¸å¤·ä¸ºä¸­åŸæ­¦æ—çš„å¸Œæœ›ï¼Œä½†ä¹Ÿæœ‰äººä»¥æˆ˜èƒœä»–ä¸ºç›®æ ‡ï¼ŒåŒ…æ‹¬é­”æ•™é‡‘é¸³ç›Ÿç›Ÿä¸»ç¬›é£å£°ã€‚ç¬›é£å£°è®¾è®¡åŠ å®³æç›¸å¤·çš„å¸ˆå…„å•å­¤åˆ€ï¼Œå¼•å¾—æç›¸å¤·ä¸ä¹‹ä¸€æˆ˜ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>åœ¨ä¸œæµ·çš„ä¸€è‰˜èˆ¹ä¸Šï¼Œæç›¸å¤·ç‹¬è‡ªä¸€äººå¯¹æŠ—é‡‘é¸³ç›Ÿçš„é«˜æ‰‹ï¼Œæœ€ç»ˆå‡»è´¥äº†å¤§éƒ¨åˆ†æ•Œäººã€‚ç¬›é£å£°çªç„¶å‡ºç°ï¼Œä¸¤äººæ¿€æˆ˜ï¼Œæç›¸å¤·åœ¨æˆ˜æ–—ä¸­ä¸­æ¯’ï¼Œæœ€ç»ˆè¢«ç¬›é£å£°é‡ä¼¤ï¼Œèˆ¹åªçˆ†ç‚¸ï¼Œæç›¸å¤·æ²‰å…¥å¤§æµ·ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>åå¹´åï¼Œæè²èŠ±åœ¨ä¸€ä¸ªå¯’é…¸çš„è²èŠ±æ¥¼å†…é†’æ¥ï¼Œè¡¨ç°å‡ºä¸æç›¸å¤·æˆªç„¶ä¸åŒçš„æ€§æ ¼ã€‚ä»–ä»¥ç¥åŒ»çš„èº«ä»½åœ¨å°é•‡ä¸Šè¡ŒåŒ»ï¼Œä½†ç”Ÿæ´»è´«å›°ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>å°é•‡ä¸Šçš„çš®å½±æˆæ‘Šè®²è¿°æç›¸å¤·å’Œç¬›é£å£°çš„æ•…äº‹ï¼Œå­©å­ä»¬äº‰è®ºè°èµ¢äº†ã€‚é£ç«å ‚ç®¡äº‹å¸¦ç€äººæ¥æ‰¾æè²èŠ±ï¼Œè¦æ±‚ä»–æ•‘æ²»ä¸€ä¸ªâ€œæ­»äººâ€ã€‚</td></tr></table></td></tr></table></div></div>

#### ğŸ“¤ output data è¾“å‡ºæ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> empty</div><div class='meta' style='margin-top:6px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; font-weight:bold; color:#555;'>__dj__meta__</td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>åå¹´å‰ï¼Œæç›¸å¤·åäº”å²æˆ˜èƒœè¥¿åŸŸå¤©é­”æˆä¸ºå¤©ä¸‹ç¬¬ä¸€é«˜æ‰‹ï¼Œåä¸ƒå²å»ºç«‹å››é¡¾é—¨ï¼ŒäºŒåå²é—®é¼æ­¦æ—ç›Ÿä¸»ï¼Œæˆä¸ºä¼ å¥‡äººç‰©ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>æœ‰äººè§†æç›¸å¤·ä¸ºä¸­åŸæ­¦æ—çš„å¸Œæœ›ï¼Œä½†ä¹Ÿæœ‰äººä»¥æˆ˜èƒœä»–ä¸ºç›®æ ‡ï¼ŒåŒ…æ‹¬é­”æ•™é‡‘é¸³ç›Ÿç›Ÿä¸»ç¬›é£å£°ã€‚ç¬›é£å£°è®¾è®¡åŠ å®³æç›¸å¤·çš„å¸ˆå…„å•å­¤åˆ€ï¼Œå¼•å¾—æç›¸å¤·ä¸ä¹‹ä¸€æˆ˜ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>åœ¨ä¸œæµ·çš„ä¸€è‰˜èˆ¹ä¸Šï¼Œæç›¸å¤·ç‹¬è‡ªä¸€äººå¯¹æŠ—é‡‘é¸³ç›Ÿçš„é«˜æ‰‹ï¼Œæœ€ç»ˆå‡»è´¥äº†å¤§éƒ¨åˆ†æ•Œäººã€‚ç¬›é£å£°çªç„¶å‡ºç°ï¼Œä¸¤äººæ¿€æˆ˜ï¼Œæç›¸å¤·åœ¨æˆ˜æ–—ä¸­ä¸­æ¯’ï¼Œæœ€ç»ˆè¢«ç¬›é£å£°é‡ä¼¤ï¼Œèˆ¹åªçˆ†ç‚¸ï¼Œæç›¸å¤·æ²‰å…¥å¤§æµ·ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>åå¹´åï¼Œæè²èŠ±åœ¨ä¸€ä¸ªå¯’é…¸çš„è²èŠ±æ¥¼å†…é†’æ¥ï¼Œè¡¨ç°å‡ºä¸æç›¸å¤·æˆªç„¶ä¸åŒçš„æ€§æ ¼ã€‚ä»–ä»¥ç¥åŒ»çš„èº«ä»½åœ¨å°é•‡ä¸Šè¡ŒåŒ»ï¼Œä½†ç”Ÿæ´»è´«å›°ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>å°é•‡ä¸Šçš„çš®å½±æˆæ‘Šè®²è¿°æç›¸å¤·å’Œç¬›é£å£°çš„æ•…äº‹ï¼Œå­©å­ä»¬äº‰è®ºè°èµ¢äº†ã€‚é£ç«å ‚ç®¡äº‹å¸¦ç€äººæ¥æ‰¾æè²èŠ±ï¼Œè¦æ±‚ä»–æ•‘æ²»ä¸€ä¸ªâ€œæ­»äººâ€ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; background-color:#ffffff !important; border-bottom:1px solid #eaecef !important; font-weight:bold; color:#555;'>__dj__batch_meta__</td></tr><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#ffffff !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 16px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#ffffff !important; border-bottom:1px solid #eaecef !important;'>æç›¸å¤·å¹´å°‘æˆåï¼Œæˆä¸ºæ­¦æ—ç›Ÿä¸»ï¼Œå´åœ¨ä¸ç¬›é£å£°çš„å†³æˆ˜ä¸­é‡ä¼¤æ²‰æµ·ã€‚åå¹´åï¼Œæè²èŠ±åœ¨å°é•‡ä¸Šä»¥ç¥åŒ»èº«ä»½è¡ŒåŒ»ï¼Œç”Ÿæ´»è´«å›°ï¼Œè€Œå…³äºæç›¸å¤·çš„ä¼ è¯´ä»åœ¨æ°‘é—´æµä¼ ã€‚</td></tr></table></div></div>

#### âœ¨ explanation è§£é‡Š
This example demonstrates the default behavior of the NestedAggregator operator. It takes a list of event descriptions and generates a summary that captures the key points from all the input texts. The output data includes the original event descriptions and an additional summary in the batch metadata, which provides a concise overview of the story. The summary is generated using the specified API model.
è¿™ä¸ªä¾‹å­å±•ç¤ºäº†NestedAggregatorç®—å­çš„é»˜è®¤è¡Œä¸ºã€‚å®ƒæ¥æ”¶ä¸€ç³»åˆ—äº‹ä»¶æè¿°ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ€»ç»“ï¼Œæ¦‚æ‹¬æ‰€æœ‰è¾“å…¥æ–‡æœ¬çš„å…³é”®ç‚¹ã€‚è¾“å‡ºæ•°æ®åŒ…æ‹¬åŸå§‹çš„äº‹ä»¶æè¿°å’Œåœ¨æ‰¹æ¬¡å…ƒæ•°æ®ä¸­æ·»åŠ çš„ä¸€ä¸ªæ€»ç»“ï¼Œè¯¥æ€»ç»“æä¾›äº†æ•…äº‹çš„ç®€è¦æ¦‚è¿°ã€‚æ€»ç»“æ˜¯é€šè¿‡æŒ‡å®šçš„APIæ¨¡å‹ç”Ÿæˆçš„ã€‚

### test_max_token_num_1
```python
NestedAggregator(api_model='qwen2.5-72b-instruct', max_token_num=2)
```

#### ğŸ“¥ input data è¾“å…¥æ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> empty</div><div class='meta' style='margin-top:6px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; font-weight:bold; color:#555;'>__dj__meta__</td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>åå¹´å‰ï¼Œæç›¸å¤·åäº”å²æˆ˜èƒœè¥¿åŸŸå¤©é­”æˆä¸ºå¤©ä¸‹ç¬¬ä¸€é«˜æ‰‹ï¼Œåä¸ƒå²å»ºç«‹å››é¡¾é—¨ï¼ŒäºŒåå²é—®é¼æ­¦æ—ç›Ÿä¸»ï¼Œæˆä¸ºä¼ å¥‡äººç‰©ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>æœ‰äººè§†æç›¸å¤·ä¸ºä¸­åŸæ­¦æ—çš„å¸Œæœ›ï¼Œä½†ä¹Ÿæœ‰äººä»¥æˆ˜èƒœä»–ä¸ºç›®æ ‡ï¼ŒåŒ…æ‹¬é­”æ•™é‡‘é¸³ç›Ÿç›Ÿä¸»ç¬›é£å£°ã€‚ç¬›é£å£°è®¾è®¡åŠ å®³æç›¸å¤·çš„å¸ˆå…„å•å­¤åˆ€ï¼Œå¼•å¾—æç›¸å¤·ä¸ä¹‹ä¸€æˆ˜ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>åœ¨ä¸œæµ·çš„ä¸€è‰˜èˆ¹ä¸Šï¼Œæç›¸å¤·ç‹¬è‡ªä¸€äººå¯¹æŠ—é‡‘é¸³ç›Ÿçš„é«˜æ‰‹ï¼Œæœ€ç»ˆå‡»è´¥äº†å¤§éƒ¨åˆ†æ•Œäººã€‚ç¬›é£å£°çªç„¶å‡ºç°ï¼Œä¸¤äººæ¿€æˆ˜ï¼Œæç›¸å¤·åœ¨æˆ˜æ–—ä¸­ä¸­æ¯’ï¼Œæœ€ç»ˆè¢«ç¬›é£å£°é‡ä¼¤ï¼Œèˆ¹åªçˆ†ç‚¸ï¼Œæç›¸å¤·æ²‰å…¥å¤§æµ·ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>åå¹´åï¼Œæè²èŠ±åœ¨ä¸€ä¸ªå¯’é…¸çš„è²èŠ±æ¥¼å†…é†’æ¥ï¼Œè¡¨ç°å‡ºä¸æç›¸å¤·æˆªç„¶ä¸åŒçš„æ€§æ ¼ã€‚ä»–ä»¥ç¥åŒ»çš„èº«ä»½åœ¨å°é•‡ä¸Šè¡ŒåŒ»ï¼Œä½†ç”Ÿæ´»è´«å›°ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>å°é•‡ä¸Šçš„çš®å½±æˆæ‘Šè®²è¿°æç›¸å¤·å’Œç¬›é£å£°çš„æ•…äº‹ï¼Œå­©å­ä»¬äº‰è®ºè°èµ¢äº†ã€‚é£ç«å ‚ç®¡äº‹å¸¦ç€äººæ¥æ‰¾æè²èŠ±ï¼Œè¦æ±‚ä»–æ•‘æ²»ä¸€ä¸ªâ€œæ­»äººâ€ã€‚</td></tr></table></td></tr></table></div></div>

#### ğŸ“¤ output data è¾“å‡ºæ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> empty</div><div class='meta' style='margin-top:6px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; font-weight:bold; color:#555;'>__dj__meta__</td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>åå¹´å‰ï¼Œæç›¸å¤·åäº”å²æˆ˜èƒœè¥¿åŸŸå¤©é­”æˆä¸ºå¤©ä¸‹ç¬¬ä¸€é«˜æ‰‹ï¼Œåä¸ƒå²å»ºç«‹å››é¡¾é—¨ï¼ŒäºŒåå²é—®é¼æ­¦æ—ç›Ÿä¸»ï¼Œæˆä¸ºä¼ å¥‡äººç‰©ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>æœ‰äººè§†æç›¸å¤·ä¸ºä¸­åŸæ­¦æ—çš„å¸Œæœ›ï¼Œä½†ä¹Ÿæœ‰äººä»¥æˆ˜èƒœä»–ä¸ºç›®æ ‡ï¼ŒåŒ…æ‹¬é­”æ•™é‡‘é¸³ç›Ÿç›Ÿä¸»ç¬›é£å£°ã€‚ç¬›é£å£°è®¾è®¡åŠ å®³æç›¸å¤·çš„å¸ˆå…„å•å­¤åˆ€ï¼Œå¼•å¾—æç›¸å¤·ä¸ä¹‹ä¸€æˆ˜ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>åœ¨ä¸œæµ·çš„ä¸€è‰˜èˆ¹ä¸Šï¼Œæç›¸å¤·ç‹¬è‡ªä¸€äººå¯¹æŠ—é‡‘é¸³ç›Ÿçš„é«˜æ‰‹ï¼Œæœ€ç»ˆå‡»è´¥äº†å¤§éƒ¨åˆ†æ•Œäººã€‚ç¬›é£å£°çªç„¶å‡ºç°ï¼Œä¸¤äººæ¿€æˆ˜ï¼Œæç›¸å¤·åœ¨æˆ˜æ–—ä¸­ä¸­æ¯’ï¼Œæœ€ç»ˆè¢«ç¬›é£å£°é‡ä¼¤ï¼Œèˆ¹åªçˆ†ç‚¸ï¼Œæç›¸å¤·æ²‰å…¥å¤§æµ·ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>åå¹´åï¼Œæè²èŠ±åœ¨ä¸€ä¸ªå¯’é…¸çš„è²èŠ±æ¥¼å†…é†’æ¥ï¼Œè¡¨ç°å‡ºä¸æç›¸å¤·æˆªç„¶ä¸åŒçš„æ€§æ ¼ã€‚ä»–ä»¥ç¥åŒ»çš„èº«ä»½åœ¨å°é•‡ä¸Šè¡ŒåŒ»ï¼Œä½†ç”Ÿæ´»è´«å›°ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; padding-left: 16px;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #eaecef !important;'><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 32px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#f8f9fa !important; border-bottom:1px solid #eaecef !important;'>å°é•‡ä¸Šçš„çš®å½±æˆæ‘Šè®²è¿°æç›¸å¤·å’Œç¬›é£å£°çš„æ•…äº‹ï¼Œå­©å­ä»¬äº‰è®ºè°èµ¢äº†ã€‚é£ç«å ‚ç®¡äº‹å¸¦ç€äººæ¥æ‰¾æè²èŠ±ï¼Œè¦æ±‚ä»–æ•‘æ²»ä¸€ä¸ªâ€œæ­»äººâ€ã€‚</td></tr></table></td></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; background-color:#ffffff !important; border-bottom:1px solid #eaecef !important; font-weight:bold; color:#555;'>__dj__batch_meta__</td></tr><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#ffffff !important; border-bottom:1px solid #eaecef !important; white-space:nowrap; padding-left: 16px;'>event_description</td><td style='text-align:left; vertical-align:top; padding:4px 8px; background-color:#ffffff !important; border-bottom:1px solid #eaecef !important;'>æç›¸å¤·åäº”å²èƒœå¤©é­”ï¼Œåä¸ƒå²åˆ›å››é¡¾é—¨ï¼ŒäºŒåå²æˆæ­¦æ—ç›Ÿä¸»ï¼Œåè¢«ç¬›é£å£°é‡ä¼¤æ²‰æµ·ï¼Œåå¹´åä»¥æè²èŠ±ä¹‹ååœ¨è²èŠ±æ¥¼è‹é†’ï¼Œè¡ŒåŒ»åº¦æ—¥ã€‚å°é•‡çš®å½±æˆè®²è¿°å…¶æ•…äº‹å¼•å‘äº‰è®®ï¼Œæè²èŠ±è¢«è¯·å»æ•‘æ²»â€œæ­»äººâ€ã€‚</td></tr></table></div></div>

#### âœ¨ explanation è§£é‡Š
This example shows how the NestedAggregator operator works with a very limited token budget (max_token_num=2). Due to the extremely low token limit, the generated summary is highly condensed, focusing only on the most critical information. The output data includes the original event descriptions and a very brief summary in the batch metadata, which highlights the main events in a few words. This edge case helps to understand the impact of token limits on the summary quality.
è¿™ä¸ªä¾‹å­å±•ç¤ºäº†NestedAggregatorç®—å­åœ¨éå¸¸æœ‰é™çš„ä»¤ç‰Œé¢„ç®—ï¼ˆmax_token_num=2ï¼‰ä¸‹çš„å·¥ä½œæƒ…å†µã€‚ç”±äºä»¤ç‰Œé™åˆ¶æä½ï¼Œç”Ÿæˆçš„æ€»ç»“éå¸¸ç²¾ç®€ï¼Œä»…å…³æ³¨æœ€å…³é”®çš„ä¿¡æ¯ã€‚è¾“å‡ºæ•°æ®åŒ…æ‹¬åŸå§‹çš„äº‹ä»¶æè¿°å’Œåœ¨æ‰¹æ¬¡å…ƒæ•°æ®ä¸­æ·»åŠ çš„ä¸€ä¸ªéå¸¸ç®€çŸ­çš„æ€»ç»“ï¼Œè¯¥æ€»ç»“ç”¨å‡ å¥è¯çªå‡ºäº†ä¸»è¦äº‹ä»¶ã€‚è¿™ä¸ªè¾¹ç¼˜æ¡ˆä¾‹æœ‰åŠ©äºç†è§£ä»¤ç‰Œé™åˆ¶å¯¹æ€»ç»“è´¨é‡çš„å½±å“ã€‚


## ğŸ”— related links ç›¸å…³é“¾æ¥
- [source code æºä»£ç ](../../../data_juicer/ops/aggregator/nested_aggregator.py)
- [unit test å•å…ƒæµ‹è¯•](../../../tests/ops/aggregator/test_nested_aggregator.py)
- [Return operator list è¿”å›ç®—å­åˆ—è¡¨](../../Operators.md)