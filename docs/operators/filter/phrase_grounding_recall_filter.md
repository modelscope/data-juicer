# phrase_grounding_recall_filter

Filter to keep samples based on the phrase grounding recall of phrases extracted from text in images.

This operator uses a Hugging Face Owl-ViT model to locate phrases extracted from the text within the images. It keeps samples where the phrase grounding recall is within a specified range. The recall is computed by comparing the number of correctly located phrases to the total number of phrases. The operator can handle multiple images per text chunk and supports different strategies for reducing the recall values (e.g., average, max, min). It also allows for flipping images horizontally or vertically. The key metric 'phrase_grounding_recall' is computed and stored in the sample's stats. If no images are present, the recall is set to an empty array.

æ ¹æ®ä»å›¾åƒä¸­æ–‡æœ¬æå–çš„çŸ­è¯­çš„å®šä½å¬å›ç‡æ¥è¿‡æ»¤æ ·æœ¬ã€‚

è¯¥ç®—å­ä½¿ç”¨ Hugging Face Owl-ViT æ¨¡å‹æ¥å®šä½ä»æ–‡æœ¬ä¸­æå–çš„çŸ­è¯­åœ¨å›¾åƒä¸­çš„ä½ç½®ã€‚å®ƒä¿ç•™çŸ­è¯­å®šä½å¬å›ç‡åœ¨æŒ‡å®šèŒƒå›´å†…çš„æ ·æœ¬ã€‚å¬å›ç‡é€šè¿‡æ¯”è¾ƒæ­£ç¡®å®šä½çš„çŸ­è¯­æ•°é‡ä¸æ€»çŸ­è¯­æ•°é‡æ¥è®¡ç®—ã€‚è¯¥ç®—å­å¯ä»¥å¤„ç†æ¯ä¸ªæ–‡æœ¬å—ä¸­çš„å¤šå¼ å›¾åƒï¼Œå¹¶æ”¯æŒä¸åŒçš„å¬å›å€¼å½’çº¦ç­–ç•¥ï¼ˆä¾‹å¦‚ï¼Œå¹³å‡å€¼ã€æœ€å¤§å€¼ã€æœ€å°å€¼ï¼‰ã€‚å®ƒè¿˜å…è®¸æ°´å¹³æˆ–å‚ç›´ç¿»è½¬å›¾åƒã€‚å…³é”®æŒ‡æ ‡ 'phrase_grounding_recall' å°†è¢«è®¡ç®—å¹¶å­˜å‚¨åœ¨æ ·æœ¬çš„ stats ä¸­ã€‚å¦‚æœæ²¡æœ‰å›¾åƒï¼Œåˆ™å¬å›ç‡è®¾ç½®ä¸ºç©ºæ•°ç»„ã€‚

Type ç®—å­ç±»å‹: **filter**

Tags æ ‡ç­¾: cpu, hf, multimodal

## ğŸ”§ Parameter Configuration å‚æ•°é…ç½®
| name å‚æ•°å | type ç±»å‹ | default é»˜è®¤å€¼ | desc è¯´æ˜ |
|--------|------|--------|------|
| `hf_owlvit` | <class 'str'> | `'google/owlvit-base-patch32'` | Owl-ViT model name on huggingface to locate the phrases extracted from the text. |
| `trust_remote_code` | <class 'bool'> | `False` | whether to trust the remote code of HF models. |
| `min_recall` | <class 'float'> | `0.1` | The min phrase grounding recall to keep samples. |
| `max_recall` | <class 'float'> | `1.0` | The max phrase grounding recall to keep samples. |
| `horizontal_flip` | <class 'bool'> | `False` | Flip image horizontally (left to right). |
| `vertical_flip` | <class 'bool'> | `False` | Flip image vertically (top to bottom). |
| `any_or_all` | <class 'str'> | `'any'` | keep this sample with 'any' or 'all' strategy of all images. 'any': keep this sample if any images meet the condition. 'all': keep this sample only if all images meet the condition. |
| `reduce_mode` | <class 'str'> | `'avg'` | reduce mode when one text corresponds to multiple images in a chunk. 'avg': Take the average of multiple values 'max': Take the max of multiple values 'min': Take the min of multiple values |
| `iou_thr` | <class 'float'> | `0.5` | the IoU threshold for NMS-like post-process. If two predicted bboxes are overlap with an IoU larger than this threshold, the bbox with less confidence will be removed. Default: 0.5. |
| `large_area_ratio_thr` | <class 'float'> | `0.95` | the area ratio threshold for filtering out those large predicted bboxes. If the area of a predicted bbox accounts for more than this ratio threshold of the whole image area, this bbox will be removed. Default: 0.95. |
| `conf_thr` | <class 'float'> | `0.0` | the confidence score threshold for removing low-confidence bboxes. If the confidence score of a predicted bbox is lower than the threshold, this bbox will be removed. Default: 0. |
| `args` |  | `''` | extra args |
| `kwargs` |  | `''` | extra args |

## ğŸ“Š Effect demonstration æ•ˆæœæ¼”ç¤º
### test_general
```python
PhraseGroundingRecallFilter(hf_owlvit='google/owlvit-base-patch32', reduce_mode='avg', any_or_all='any', min_recall=0.5, max_recall=1.0)
```

#### ğŸ“¥ input data è¾“å…¥æ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text | 1 image</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__image&gt;a woman sitting on the beach with a dog</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">blip.jpg:</div><div class="image-grid"><img src="../../../tests/ops/data/blip.jpg" width="160" style="margin:4px;"/></div></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text | 1 image</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Two cats are sleeping on the couch with two remote controls&lt;__dj__image&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">cat.jpg:</div><div class="image-grid"><img src="../../../tests/ops/data/cat.jpg" width="160" style="margin:4px;"/></div></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text | 1 image</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__image&gt; select luxury furniture 3 - inch gel memory foam mattress topper &lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">img1.png:</div><div class="image-grid"><img src="../../../tests/ops/data/img1.png" width="160" style="margin:4px;"/></div></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 4:</strong> text | 1 image</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__image&gt; A bus with red advertisements is running on the street. &lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">img2.jpg:</div><div class="image-grid"><img src="../../../tests/ops/data/img2.jpg" width="160" style="margin:4px;"/></div></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 5:</strong> text | 1 image</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__image&gt; A woman carrying a bag is walking in a rainy alley holding an umbrella &lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">img3.jpg:</div><div class="image-grid"><img src="../../../tests/ops/data/img3.jpg" width="160" style="margin:4px;"/></div></div></div>

#### ğŸ“¤ output data è¾“å‡ºæ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text | 1 image</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__image&gt;a woman sitting on the beach with a dog</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">blip.jpg:</div><div class="image-grid"><img src="../../../tests/ops/data/blip.jpg" width="160" style="margin:4px;"/></div></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text | 1 image</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Two cats are sleeping on the couch with two remote controls&lt;__dj__image&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">cat.jpg:</div><div class="image-grid"><img src="../../../tests/ops/data/cat.jpg" width="160" style="margin:4px;"/></div></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text | 1 image</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__image&gt; select luxury furniture 3 - inch gel memory foam mattress topper &lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">img1.png:</div><div class="image-grid"><img src="../../../tests/ops/data/img1.png" width="160" style="margin:4px;"/></div></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 4:</strong> text | 1 image</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__image&gt; A bus with red advertisements is running on the street. &lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">img2.jpg:</div><div class="image-grid"><img src="../../../tests/ops/data/img2.jpg" width="160" style="margin:4px;"/></div></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 5:</strong> text | 1 image</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__image&gt; A woman carrying a bag is walking in a rainy alley holding an umbrella &lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">img3.jpg:</div><div class="image-grid"><img src="../../../tests/ops/data/img3.jpg" width="160" style="margin:4px;"/></div></div></div>

#### âœ¨ explanation è§£é‡Š
The operator keeps all samples where the phrase grounding recall is between 0.5 and 1.0, as calculated by averaging the recalls of phrases found in each image. Since all images have a recall within this range, all samples are kept.
ç®—å­ä¿ç•™äº†æ‰€æœ‰æ ·æœ¬ï¼Œå…¶ä¸­çŸ­è¯­å®šä½å¬å›ç‡åœ¨0.5åˆ°1.0ä¹‹é—´ï¼Œè¿™æ˜¯é€šè¿‡å¹³å‡æ¯ä¸ªå›¾åƒä¸­æ‰¾åˆ°çš„çŸ­è¯­çš„å¬å›ç‡æ¥è®¡ç®—çš„ã€‚ç”±äºæ‰€æœ‰å›¾åƒçš„å¬å›ç‡éƒ½åœ¨è¿™ä¸ªèŒƒå›´å†…ï¼Œå› æ­¤æ‰€æœ‰æ ·æœ¬éƒ½è¢«ä¿ç•™ã€‚

### test_high_area_ratio
```python
PhraseGroundingRecallFilter(hf_owlvit='google/owlvit-base-patch32', reduce_mode='avg', any_or_all='any', min_recall=0.5, max_recall=1.0, large_area_ratio_thr=0.99)
```

#### ğŸ“¥ input data è¾“å…¥æ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text | 1 image</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__image&gt; a photo of a woman&#x27;s face</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">lena-face.jpg:</div><div class="image-grid"><img src="../../../tests/ops/data/lena-face.jpg" width="160" style="margin:4px;"/></div></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text | 1 image</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__image&gt;A bus with red advertisements is running on the street.</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">img2.jpg:</div><div class="image-grid"><img src="../../../tests/ops/data/img2.jpg" width="160" style="margin:4px;"/></div></div></div>

#### ğŸ“¤ output data è¾“å‡ºæ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text | 1 image</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__image&gt;A bus with red advertisements is running on the street.</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">img2.jpg:</div><div class="image-grid"><img src="../../../tests/ops/data/img2.jpg" width="160" style="margin:4px;"/></div></div></div>

#### âœ¨ explanation è§£é‡Š
The operator removes samples if any object in the image occupies an area larger than 99% of the total image area. In this case, the sample with a woman's face is removed because it likely exceeds the area threshold, while the bus sample is kept as it does not exceed the threshold.
å¦‚æœå›¾åƒä¸­çš„ä»»ä½•å¯¹è±¡å æ®çš„é¢ç§¯è¶…è¿‡æ•´ä¸ªå›¾åƒé¢ç§¯çš„99%ï¼Œåˆ™ç®—å­ä¼šç§»é™¤è¯¥æ ·æœ¬ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒåŒ…å«å¥³æ€§è„¸éƒ¨çš„ç…§ç‰‡è¢«ç§»é™¤ï¼Œå› ä¸ºå®ƒå¯èƒ½è¶…è¿‡äº†é¢ç§¯é˜ˆå€¼ï¼Œè€Œå…¬äº¤è½¦çš„ç…§ç‰‡è¢«ä¿ç•™ï¼Œå› ä¸ºå®ƒæ²¡æœ‰è¶…è¿‡é˜ˆå€¼ã€‚


## ğŸ”— related links ç›¸å…³é“¾æ¥
- [source code æºä»£ç ](../../../data_juicer/ops/filter/phrase_grounding_recall_filter.py)
- [unit test å•å…ƒæµ‹è¯•](../../../tests/ops/filter/test_phrase_grounding_recall_filter.py)
- [Return operator list è¿”å›ç®—å­åˆ—è¡¨](../../Operators.md)