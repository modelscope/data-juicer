# perplexity_filter

Filter to keep samples with perplexity score in a specified range.

This operator computes the perplexity of text samples using a Hugging Face tokenizer and a KenLM language model. It keeps samples with perplexity scores within the specified minimum and maximum values. The perplexity is calculated character-based by default. If the perplexity is already computed, it will be reused from the 'perplexity' field in the sample's stats. The operator supports batched operations for efficiency.

ç”¨äºä¿ç•™æŒ‡å®šå›°æƒ‘åº¦èŒƒå›´å†…çš„æ ·æœ¬çš„è¿‡æ»¤å™¨ã€‚

è¯¥ç®—å­ä½¿ç”¨ Hugging Face åˆ†è¯å™¨å’Œ KenLM è¯­è¨€æ¨¡å‹è®¡ç®—æ–‡æœ¬æ ·æœ¬çš„å›°æƒ‘åº¦ã€‚å®ƒä¿ç•™å›°æƒ‘åº¦åˆ†æ•°åœ¨æŒ‡å®šæœ€å°å€¼å’Œæœ€å¤§å€¼èŒƒå›´å†…çš„æ ·æœ¬ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå›°æƒ‘åº¦æ˜¯åŸºäºå­—ç¬¦è®¡ç®—çš„ã€‚å¦‚æœå›°æƒ‘åº¦å·²ç»è®¡ç®—è¿‡ï¼Œåˆ™ä¼šä»æ ·æœ¬çš„ stats ä¸­çš„ 'perplexity' å­—æ®µé‡ç”¨ã€‚è¯¥ç®—å­æ”¯æŒæ‰¹é‡æ“ä½œä»¥æé«˜æ•ˆç‡ã€‚

Type ç®—å­ç±»å‹: **filter**

Tags æ ‡ç­¾: cpu, text

## ğŸ”§ Parameter Configuration å‚æ•°é…ç½®
| name å‚æ•°å | type ç±»å‹ | default é»˜è®¤å€¼ | desc è¯´æ˜ |
|--------|------|--------|------|
| `lang` | <class 'str'> | `'en'` | Compute perplexity for samples in which language. |
| `min_ppl` | <class 'float'> | `0` | The min filter perplexity in this op. |
| `max_ppl` | <class 'float'> | `1500` | The max filter perplexity in this op. |
| `args` |  | `''` | extra args |
| `kwargs` |  | `''` | extra args |

## ğŸ“Š Effect demonstration æ•ˆæœæ¼”ç¤º
### test_en_case_default
```python
PerplexityFilter(lang='en', max_ppl=900, batch_size=2)
```

#### ğŸ“¥ input data è¾“å…¥æ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Today is Sunday and it&#x27;s a happy day!</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Today is Sund Sund Sund Sund Sunda and it&#x27;s a happy day!</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">a v s e c s f e f g a qkc</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 4:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">ï¼Œã€‚ã€â€â€â€œÂ«Â»ï¼‘ã€ã€Œã€Šã€‹Â´âˆ¶ï¼šï¼Ÿï¼ï¼ˆï¼‰ï¼›â€“â€”ï¼ï½â€™â€¦â”ã€ˆã€‰ã€ã€‘ï¼…â–º</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 5:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Do you need a cup of coffee?</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 6:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">emojiè¡¨æƒ…æµ‹è¯•ä¸‹ğŸ˜Šï¼ŒğŸ˜¸31231</pre></div>

#### ğŸ“¤ output data è¾“å‡ºæ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Today is Sunday and it&#x27;s a happy day!</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Do you need a cup of coffee?</pre></div>

#### âœ¨ explanation è§£é‡Š
This example demonstrates the PerplexityFilter operator in its simplest form, filtering out text samples with a perplexity score higher than 900. The output data only contains the samples that have a perplexity score less than or equal to 900.
æ­¤ç¤ºä¾‹å±•ç¤ºäº†PerplexityFilterç®—å­æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼ï¼Œè¿‡æ»¤æ‰å›°æƒ‘åº¦åˆ†æ•°é«˜äº900çš„æ–‡æœ¬æ ·æœ¬ã€‚è¾“å‡ºæ•°æ®åªåŒ…å«é‚£äº›å›°æƒ‘åº¦åˆ†æ•°å°äºæˆ–ç­‰äº900çš„æ ·æœ¬ã€‚

### test_en_case_context
```python
PerplexityFilter(lang='en', max_ppl=900, batch_size=2)
```

#### ğŸ“¥ input data è¾“å…¥æ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Today is Sunday and it&#x27;s a happy day!</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Today is Sund Sund Sund Sund Sunda and it&#x27;s a happy day!</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">a v s e c s f e f g a qkc</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 4:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">ï¼Œã€‚ã€â€â€â€œÂ«Â»ï¼‘ã€ã€Œã€Šã€‹Â´âˆ¶ï¼šï¼Ÿï¼ï¼ˆï¼‰ï¼›â€“â€”ï¼ï½â€™â€¦â”ã€ˆã€‰ã€ã€‘ï¼…â–º</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 5:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Do you need a cup of coffee?</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 6:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">emojiè¡¨æƒ…æµ‹è¯•ä¸‹ğŸ˜Šï¼ŒğŸ˜¸31231</pre></div>

#### ğŸ“¤ output data è¾“å‡ºæ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Today is Sunday and it&#x27;s a happy day!</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Do you need a cup of coffee?</pre></div>

#### âœ¨ explanation è§£é‡Š
In this example, the PerplexityFilter operator is used with an additional context argument set to True. This allows the operator to also return the tokenized words (context) for each kept sample. However, the displayed output data only shows the final filtered text samples, similar to the 'test_en_case_default' method. The actual raw output from the operator includes both the filtered text and their corresponding tokenized contexts, but these are not shown in the provided output data.
åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼ŒPerplexityFilterç®—å­ä½¿ç”¨äº†ä¸€ä¸ªé¢å¤–çš„ä¸Šä¸‹æ–‡å‚æ•°ï¼Œå¹¶è®¾ç½®ä¸ºTrueã€‚è¿™ä½¿å¾—ç®—å­è¿˜èƒ½è¿”å›æ¯ä¸ªä¿ç•™æ ·æœ¬çš„åˆ†è¯ç»“æœï¼ˆä¸Šä¸‹æ–‡ï¼‰ã€‚ä½†æ˜¯ï¼Œæ˜¾ç¤ºçš„è¾“å‡ºæ•°æ®åªåŒ…å«äº†æœ€ç»ˆè¿‡æ»¤åçš„æ–‡æœ¬æ ·æœ¬ï¼Œç±»ä¼¼äº'test_en_case_default'æ–¹æ³•ã€‚ç®—å­çš„å®é™…åŸå§‹è¾“å‡ºåŒ…æ‹¬è¿‡æ»¤åçš„æ–‡æœ¬åŠå…¶å¯¹åº”çš„åˆ†è¯ä¸Šä¸‹æ–‡ï¼Œä½†åœ¨æä¾›çš„è¾“å‡ºæ•°æ®ä¸­å¹¶æ²¡æœ‰å±•ç¤ºè¿™äº›ä¿¡æ¯ã€‚


## ğŸ”— related links ç›¸å…³é“¾æ¥
- [source code æºä»£ç ](../../../data_juicer/ops/filter/perplexity_filter.py)
- [unit test å•å…ƒæµ‹è¯•](../../../tests/ops/filter/test_perplexity_filter.py)
- [Return operator list è¿”å›ç®—å­åˆ—è¡¨](../../Operators.md)