# word_repetition_filter

Filter to keep samples with word-level n-gram repetition ratio within a specific range.

This operator calculates the word-level n-gram repetition ratio for each sample and filters out those that do not fall within the specified range. The n-gram length and the min/max ratio thresholds are configurable. If tokenization is enabled, a Hugging Face tokenizer is used to tokenize the text. The key metric, `word_rep_ratio`, is computed as the ratio of repeated n-grams to the total number of n-grams. This ratio is then compared against the min and max ratio thresholds to decide whether to keep or filter the sample. If the ratio is outside the specified range, the sample is filtered out.

ç­›é€‰å•è¯çº§ n-gram é‡å¤æ¯”ç‡åœ¨ç‰¹å®šèŒƒå›´å†…çš„æ ·æœ¬ã€‚

è¯¥ç®—å­è®¡ç®—æ¯ä¸ªæ ·æœ¬çš„å•è¯çº§ n-gram é‡å¤æ¯”ç‡ï¼Œå¹¶è¿‡æ»¤æ‰ä¸åœ¨æŒ‡å®šèŒƒå›´å†…çš„æ ·æœ¬ã€‚n-gram é•¿åº¦å’Œæœ€å°/æœ€å¤§æ¯”ç‡é˜ˆå€¼æ˜¯å¯é…ç½®çš„ã€‚å¦‚æœå¯ç”¨åˆ†è¯ï¼Œåˆ™ä½¿ç”¨ Hugging Face åˆ†è¯å™¨å¯¹æ–‡æœ¬è¿›è¡Œåˆ†è¯ã€‚å…³é”®æŒ‡æ ‡ `word_rep_ratio` è®¡ç®—ä¸ºé‡å¤ n-gram ä¸æ€» n-gram æ•°é‡çš„æ¯”ç‡ã€‚ç„¶åå°†æ­¤æ¯”ç‡ä¸æœ€å°å’Œæœ€å¤§æ¯”ç‡é˜ˆå€¼è¿›è¡Œæ¯”è¾ƒï¼Œä»¥å†³å®šæ˜¯å¦ä¿ç•™æˆ–è¿‡æ»¤æ ·æœ¬ã€‚å¦‚æœæ¯”ç‡è¶…å‡ºæŒ‡å®šèŒƒå›´ï¼Œåˆ™è¿‡æ»¤æ‰æ ·æœ¬ã€‚

Type ç®—å­ç±»å‹: **filter**

Tags æ ‡ç­¾: cpu, text

## ğŸ”§ Parameter Configuration å‚æ•°é…ç½®
| name å‚æ•°å | type ç±»å‹ | default é»˜è®¤å€¼ | desc è¯´æ˜ |
|--------|------|--------|------|
| `lang` | <class 'str'> | `'en'` | sample in which language. |
| `tokenization` | <class 'bool'> | `False` | whether to use model to tokenize documents |
| `rep_len` | typing.Annotated[int, Gt(gt=0)] | `10` | Repetition length for word-level n-gram. |
| `min_ratio` | <class 'float'> | `0.0` | The min filter ratio in this op, samples will be filtered if their word-level n-gram repetition ratio is below this parameter. |
| `max_ratio` | <class 'float'> | `0.5` | The max filter ratio in this op, samples will be filtered if their word-level n-gram repetition ratio exceeds this parameter. |
| `args` |  | `''` | extra args |
| `kwargs` |  | `''` | extra args |

## ğŸ“Š Effect demonstration æ•ˆæœæ¼”ç¤º
### test_en_case
```python
WordRepetitionFilter(rep_len=3, min_ratio=0.0, max_ratio=0.2, batch_size=2)
```

#### ğŸ“¥ input data è¾“å…¥æ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Today is Sunday Sunday Sunday Sunday Sunday and it&#x27;s a happy day!</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Today is Sunday Sunday Sunday and it&#x27;s a happy day!</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Today is Sund Sund Sund Sund Sund Sunda and it&#x27;s a happy day!</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 4:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">plusieurs Ã¨rdash@hqbchd.ckd d&#x27;accÃ©der Ã  ces wwwasdasd fonc</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 5:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">This proposed a novel proposed pretraining proposed pretraining.</pre></div>

#### ğŸ“¤ output data è¾“å‡ºæ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Today is Sunday Sunday Sunday and it&#x27;s a happy day!</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">plusieurs Ã¨rdash@hqbchd.ckd d&#x27;accÃ©der Ã  ces wwwasdasd fonc</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">This proposed a novel proposed pretraining proposed pretraining.</pre></div>

#### âœ¨ explanation è§£é‡Š
The operator filters samples based on the word-level 3-gram repetition ratio, keeping those with a ratio between 0.0 and 0.2. Samples with higher ratios are removed because they exceed the maximum allowed repetition ratio.
è¯¥ç®—å­åŸºäºè¯çº§3-gramé‡å¤ç‡è¿‡æ»¤æ ·æœ¬ï¼Œä¿ç•™æ¯”ç‡åœ¨0.0åˆ°0.2ä¹‹é—´çš„æ ·æœ¬ã€‚æ¯”ç‡è¶…è¿‡æœ€å¤§å…è®¸å€¼çš„æ ·æœ¬è¢«ç§»é™¤ã€‚

### test_zh_case
```python
WordRepetitionFilter(lang='zh', tokenization=True, rep_len=3, min_ratio=0.0, max_ratio=0.2, batch_size=1)
```

#### ğŸ“¥ input data è¾“å…¥æ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">å»é™¤å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å æ¯”è¿‡ä½æˆ–è¿‡é«˜çš„ä»£ç </pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">æ¬¢è¿æ¥åˆ°é˜¿é‡Œå·´å·´å·´å·´å·´å·´å·´å·´</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">ä½¿ç”¨ç‰‡æ®µåˆ†è¯å™¨å¯¹æ¯ä¸ªé¡µé¢è¿›è¡Œåˆ†è¯ï¼Œä½¿ç”¨è¯­è¨€æ¨¡å‹è®¡ç®—æ¯ä¸ªæ®µè½çš„å›°æƒ‘åº¦å¾—åˆ†</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 4:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">æ ¹æ®ç®—å­ä½¿ç”¨ä½¿ç”¨ä½¿ç”¨ä½¿ç”¨å®‰è£…æ–¹æ¡ˆç¡®å®š</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 5:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">åŸºäºå‰ä¸€æ­¥ç»“æœï¼Œåœ¨åŒä¸€ä¸ªèšç±»ä¸­æ‰¾å‡ºé‚£äº›è¿‡é•¿æ–‡æ¡£ä¸ºå‡æ­£ä¾‹ï¼Œæš‚ä¸è¿›è¡Œæ»¤é™¤</pre></div>

#### ğŸ“¤ output data è¾“å‡ºæ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">å»é™¤å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å æ¯”è¿‡ä½æˆ–è¿‡é«˜çš„ä»£ç </pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">ä½¿ç”¨ç‰‡æ®µåˆ†è¯å™¨å¯¹æ¯ä¸ªé¡µé¢è¿›è¡Œåˆ†è¯ï¼Œä½¿ç”¨è¯­è¨€æ¨¡å‹è®¡ç®—æ¯ä¸ªæ®µè½çš„å›°æƒ‘åº¦å¾—åˆ†</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">åŸºäºå‰ä¸€æ­¥ç»“æœï¼Œåœ¨åŒä¸€ä¸ªèšç±»ä¸­æ‰¾å‡ºé‚£äº›è¿‡é•¿æ–‡æ¡£ä¸ºå‡æ­£ä¾‹ï¼Œæš‚ä¸è¿›è¡Œæ»¤é™¤</pre></div>

#### âœ¨ explanation è§£é‡Š
The operator, configured for Chinese and using tokenization, filters out samples with a 3-gram repetition ratio outside the 0.0 to 0.2 range. It keeps texts that do not have excessive n-gram repetitions as per the defined criteria.
è¯¥ç®—å­é’ˆå¯¹ä¸­æ–‡é…ç½®ï¼Œå¹¶ä½¿ç”¨åˆ†è¯ï¼Œè¿‡æ»¤æ‰3-gramé‡å¤ç‡ä¸åœ¨0.0åˆ°0.2èŒƒå›´å†…çš„æ ·æœ¬ã€‚æ ¹æ®å®šä¹‰çš„æ ‡å‡†ï¼Œå®ƒä¿ç•™äº†æ²¡æœ‰è¿‡å¤šn-gramé‡å¤çš„æ–‡æœ¬ã€‚


## ğŸ”— related links ç›¸å…³é“¾æ¥
- [source code æºä»£ç ](../../../data_juicer/ops/filter/word_repetition_filter.py)
- [unit test å•å…ƒæµ‹è¯•](../../../tests/ops/filter/test_word_repetition_filter.py)
- [Return operator list è¿”å›ç®—å­åˆ—è¡¨](../../Operators.md)