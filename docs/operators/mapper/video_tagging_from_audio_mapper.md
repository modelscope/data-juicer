# video_tagging_from_audio_mapper

Generates video tags from audio streams using the Audio Spectrogram Transformer.

This operator extracts audio streams from videos and uses a Hugging Face Audio Spectrogram Transformer (AST) model to generate tags. The tags are stored in the specified metadata field, defaulting to 'video_audio_tags'. If no valid audio stream is found, the tag is set to 'EMPTY'. The operator resamples audio to match the model's required sampling rate if necessary. The tags are inferred based on the highest logit value from the model's output. If the tags are already present in the sample, the operator skips processing for that sample.

ä½¿ç”¨ Audio Spectrogram Transformer ä»éŸ³é¢‘æµç”Ÿæˆè§†é¢‘æ ‡ç­¾ã€‚

æ­¤ç®—å­ä»è§†é¢‘ä¸­æå–éŸ³é¢‘æµï¼Œå¹¶ä½¿ç”¨ Hugging Face çš„ Audio Spectrogram Transformer (AST) æ¨¡å‹ç”Ÿæˆæ ‡ç­¾ã€‚æ ‡ç­¾å­˜å‚¨åœ¨æŒ‡å®šçš„å…ƒæ•°æ®å­—æ®µä¸­ï¼Œé»˜è®¤ä¸º 'video_audio_tags'ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„éŸ³é¢‘æµï¼Œåˆ™æ ‡ç­¾è®¾ç½®ä¸º 'EMPTY'ã€‚å¦‚æœéœ€è¦ï¼Œè¯¥ç®—å­ä¼šå¯¹éŸ³é¢‘é‡æ–°é‡‡æ ·ä»¥åŒ¹é…æ¨¡å‹æ‰€éœ€çš„é‡‡æ ·ç‡ã€‚æ ‡ç­¾åŸºäºæ¨¡å‹è¾“å‡ºçš„æœ€é«˜ logit å€¼æ¨æ–­ã€‚å¦‚æœæ ·æœ¬ä¸­å·²ç»å­˜åœ¨æ ‡ç­¾ï¼Œåˆ™è¯¥ç®—å­è·³è¿‡å¯¹è¯¥æ ·æœ¬çš„å¤„ç†ã€‚

Type ç®—å­ç±»å‹: **mapper**

Tags æ ‡ç­¾: cpu, hf, video

## ğŸ”§ Parameter Configuration å‚æ•°é…ç½®
| name å‚æ•°å | type ç±»å‹ | default é»˜è®¤å€¼ | desc è¯´æ˜ |
|--------|------|--------|------|
| `hf_ast` | <class 'str'> | `'MIT/ast-finetuned-audioset-10-10-0.4593'` | path to the HF model to tag from audios. |
| `trust_remote_code` | <class 'bool'> | `False` | whether to trust the remote code of HF models |
| `tag_field_name` | <class 'str'> | `'video_audio_tags'` | the field name to store the tags. It's "video_audio_tags" in default. |
| `args` |  | `''` | extra args |
| `kwargs` |  | `''` | extra args |

## ğŸ“Š Effect demonstration æ•ˆæœæ¼”ç¤º
### test
```python
VideoTaggingFromAudioMapper('MIT/ast-finetuned-audioset-10-10-0.4593')
```

#### ğŸ“¥ input data è¾“å…¥æ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; ç™½è‰²çš„å°ç¾Šç«™åœ¨ä¸€æ—è®²è¯ã€‚æ—è¾¹è¿˜æœ‰ä¸¤åªç°è‰²çŒ«å’ªå’Œä¸€åªæ‹‰ç€ç°ç‹¼çš„çŒ«å’ªã€‚</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video1.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video1.mp4" controls width="320" style="margin:4px;"></video></div></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; èº«ç©¿ç™½è‰²ä¸Šè¡£çš„ç”·å­ï¼Œæ‹¿ç€ä¸€ä¸ªä¸œè¥¿ï¼Œæ‹æ‰“è‡ªå·±çš„èƒƒéƒ¨ã€‚&lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video2.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video2.mp4" controls width="320" style="margin:4px;"></video></div></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; ä¸€ä¸ªäººåœ¨å¸®å¦ä¸€ä¸ªäººæ¢³å¤´å‘ã€‚ &lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video4.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video4.mp4" controls width="320" style="margin:4px;"></video></div></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 4:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; ä¸€ä¸ªç©¿ç€çº¢è‰²è¿è¡£è£™çš„å¥³äººåœ¨è¯•è¡£æœã€‚ &lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video5.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video5.mp4" controls width="320" style="margin:4px;"></video></div></div></div>

#### ğŸ“¤ output data è¾“å‡ºæ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> list</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">[[&#x27;Music&#x27;], [&#x27;Music&#x27;], [&#x27;Speech&#x27;], [&#x27;Speech&#x27;]]</pre></div>

#### âœ¨ explanation è§£é‡Š
This example demonstrates the typical usage of the operator, where it processes a list of video samples and generates audio tags. The operator extracts the audio from each video, uses the Audio Spectrogram Transformer (AST) model to analyze the audio, and then assigns a tag ('Music' or 'Speech') based on the highest logit value. The output data shows the assigned tags for each sample, indicating that the first two videos are tagged as 'Music' and the last two as 'Speech'.
è¯¥ç¤ºä¾‹å±•ç¤ºäº†ç®—å­çš„å…¸å‹ç”¨æ³•ï¼Œå®ƒå¤„ç†ä¸€ç³»åˆ—è§†é¢‘æ ·æœ¬å¹¶ç”ŸæˆéŸ³é¢‘æ ‡ç­¾ã€‚ç®—å­ä»æ¯ä¸ªè§†é¢‘ä¸­æå–éŸ³é¢‘ï¼Œä½¿ç”¨éŸ³é¢‘é¢‘è°±å›¾å˜æ¢å™¨ï¼ˆASTï¼‰æ¨¡å‹åˆ†æéŸ³é¢‘ï¼Œç„¶åæ ¹æ®æœ€é«˜çš„logitå€¼åˆ†é…ä¸€ä¸ªæ ‡ç­¾ï¼ˆ'éŸ³ä¹'æˆ–'è¯­éŸ³'ï¼‰ã€‚è¾“å‡ºæ•°æ®æ˜¾ç¤ºäº†ä¸ºæ¯ä¸ªæ ·æœ¬åˆ†é…çš„æ ‡ç­¾ï¼Œè¡¨æ˜å‰ä¸¤ä¸ªè§†é¢‘è¢«æ ‡è®°ä¸º'éŸ³ä¹'ï¼Œåä¸¤ä¸ªè¢«æ ‡è®°ä¸º'è¯­éŸ³'ã€‚

### test_no_audio
```python
VideoTaggingFromAudioMapper('MIT/ast-finetuned-audioset-10-10-0.4593')
```

#### ğŸ“¥ input data è¾“å…¥æ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text | 3 videos</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; &lt;__dj__video&gt; ç™½è‰²çš„å°ç¾Šç«™åœ¨ä¸€æ—è®²è¯ã€‚æ—è¾¹è¿˜æœ‰ä¸¤åªç°è‰²çŒ«å’ªå’Œä¸€åªæ‹‰ç€ç°ç‹¼çš„çŒ«å’ª; ä¸¤ä¸ªé•¿å¤´å‘çš„å¥³å­æ­£ååœ¨ä¸€å¼ åœ†æ¡Œå‰è®²è¯äº’åŠ¨ã€‚ &lt;|__dj__eoc|&gt;&lt;__dj__video&gt; èº«ç©¿ç™½è‰²ä¸Šè¡£çš„ç”·å­ï¼Œæ‹¿ç€ä¸€ä¸ªä¸œè¥¿ï¼Œæ‹æ‰“è‡ªå·±çš„èƒƒéƒ¨ã€‚</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video1.mp4 +2 more:</div><div class="video-grid"><video src="../../../tests/ops/data/video1.mp4" controls width="320" style="margin:4px;"></video></div><details style='margin:6px 0;'><summary style='cursor:pointer; color:#0366d6;'>Show 2 more videos å±•å¼€æ›´å¤šè§†é¢‘</summary><div class="video-grid"><video src="../../../tests/ops/data/video3-no-audio.mp4" controls width="320" style="margin:4px;"></video><video src="../../../tests/ops/data/video2.mp4" controls width="320" style="margin:4px;"></video></div></details></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text | 3 videos</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; &lt;__dj__video&gt; ä¸¤ä¸ªé•¿å¤´å‘çš„å¥³å­æ­£ååœ¨ä¸€å¼ åœ†æ¡Œå‰è®²è¯äº’åŠ¨ã€‚ &lt;__dj__video&gt; ä¸€ä¸ªäººåœ¨å¸®å¦ä¸€ä¸ªäººæ¢³å¤´å‘ã€‚</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video3.mp4 +2 more:</div><div class="video-grid"><video src="../../../tests/ops/data/video3.mp4" controls width="320" style="margin:4px;"></video></div><details style='margin:6px 0;'><summary style='cursor:pointer; color:#0366d6;'>Show 2 more videos å±•å¼€æ›´å¤šè§†é¢‘</summary><div class="video-grid"><video src="../../../tests/ops/data/video3-no-audio.mp4" controls width="320" style="margin:4px;"></video><video src="../../../tests/ops/data/video4.mp4" controls width="320" style="margin:4px;"></video></div></details></div></div>

#### ğŸ“¤ output data è¾“å‡ºæ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> list</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">[[&#x27;Music&#x27;, &#x27;EMPTY&#x27;, &#x27;Music&#x27;], [&#x27;Music&#x27;, &#x27;EMPTY&#x27;, &#x27;Speech&#x27;]]</pre></div>

#### âœ¨ explanation è§£é‡Š
This example illustrates an important edge case where some videos do not have an audio stream. In such cases, the operator still processes the videos but assigns the 'EMPTY' tag to those without valid audio. This ensures that all videos, even those with missing audio, are accounted for in the dataset. The output data shows that the second video in the first sample and the second video in the second sample are tagged as 'EMPTY', while the rest are tagged as 'Music' or 'Speech' based on their audio content.
è¯¥ç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªé‡è¦çš„è¾¹ç¼˜æƒ…å†µï¼Œå³æŸäº›è§†é¢‘æ²¡æœ‰éŸ³é¢‘æµã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç®—å­ä»ç„¶å¤„ç†è¿™äº›è§†é¢‘ï¼Œä½†å¯¹é‚£äº›æ²¡æœ‰æœ‰æ•ˆéŸ³é¢‘çš„è§†é¢‘åˆ†é…'EMPTY'æ ‡ç­¾ã€‚è¿™ç¡®ä¿äº†æ‰€æœ‰è§†é¢‘ï¼Œå³ä½¿é‚£äº›ç¼ºå°‘éŸ³é¢‘çš„è§†é¢‘ï¼Œåœ¨æ•°æ®é›†ä¸­ä¹Ÿè¢«è€ƒè™‘åœ¨å†…ã€‚è¾“å‡ºæ•°æ®æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ ·æœ¬ä¸­çš„ç¬¬äºŒä¸ªè§†é¢‘å’Œç¬¬äºŒä¸ªæ ·æœ¬ä¸­çš„ç¬¬äºŒä¸ªè§†é¢‘è¢«æ ‡è®°ä¸º'EMPTY'ï¼Œè€Œå…¶ä½™çš„åˆ™æ ¹æ®å…¶éŸ³é¢‘å†…å®¹è¢«æ ‡è®°ä¸º'éŸ³ä¹'æˆ–'è¯­éŸ³'ã€‚


## ğŸ”— related links ç›¸å…³é“¾æ¥
- [source code æºä»£ç ](../../../data_juicer/ops/mapper/video_tagging_from_audio_mapper.py)
- [unit test å•å…ƒæµ‹è¯•](../../../tests/ops/mapper/test_video_tagging_from_audio_mapper.py)
- [Return operator list è¿”å›ç®—å­åˆ—è¡¨](../../Operators.md)