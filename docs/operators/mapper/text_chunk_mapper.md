# text_chunk_mapper

Split input text into chunks based on specified criteria.

- Splits the input text into multiple chunks using a specified maximum length and a split pattern.
- If `max_len` is provided, the text is split into chunks with a maximum length of `max_len`.
- If `split_pattern` is provided, the text is split at occurrences of the pattern. If the length exceeds `max_len`, it will force a cut.
- The `overlap_len` parameter specifies the overlap length between consecutive chunks if the split does not occur at the pattern.
- Uses a Hugging Face tokenizer to calculate the text length in tokens if a tokenizer name is provided; otherwise, it uses the string length.
- Caches the following stats: 'chunk_count' (number of chunks generated for each sample).
- Raises a `ValueError` if both `max_len` and `split_pattern` are `None` or if `overlap_len` is greater than or equal to `max_len`.

æ ¹æ®æŒ‡å®šçš„æ ‡å‡†å°†è¾“å…¥æ–‡æœ¬æ‹†åˆ†æˆå¤šä¸ªå—ã€‚

- ä½¿ç”¨æŒ‡å®šçš„æœ€å¤§é•¿åº¦å’Œæ‹†åˆ†æ¨¡å¼å°†è¾“å…¥æ–‡æœ¬æ‹†åˆ†æˆå¤šä¸ªå—ã€‚
- å¦‚æœæä¾›äº†`max_len`ï¼Œåˆ™å°†æ–‡æœ¬æ‹†åˆ†æˆæœ€å¤§é•¿åº¦ä¸º`max_len`çš„å—ã€‚
- å¦‚æœæä¾›äº†`split_pattern`ï¼Œåˆ™åœ¨æ¨¡å¼å‡ºç°å¤„æ‹†åˆ†æ–‡æœ¬ã€‚å¦‚æœé•¿åº¦è¶…è¿‡`max_len`ï¼Œåˆ™ä¼šå¼ºåˆ¶åˆ‡å‰²ã€‚
- `overlap_len`å‚æ•°æŒ‡å®šè¿ç»­å—ä¹‹é—´çš„é‡å é•¿åº¦ï¼Œå¦‚æœæ‹†åˆ†ä¸åœ¨æ¨¡å¼å¤„å‘ç”Ÿã€‚
- å¦‚æœæä¾›äº†tokenizeråç§°ï¼Œåˆ™ä½¿ç”¨Hugging Face tokenizerè®¡ç®—tokené•¿åº¦ï¼›å¦åˆ™ï¼Œä½¿ç”¨å­—ç¬¦ä¸²é•¿åº¦ã€‚
- ç¼“å­˜ä»¥ä¸‹ç»Ÿè®¡ä¿¡æ¯ï¼š'chunk_count'ï¼ˆä¸ºæ¯ä¸ªæ ·æœ¬ç”Ÿæˆçš„å—æ•°ï¼‰ã€‚
- å¦‚æœ`max_len`å’Œ`split_pattern`éƒ½ä¸º`None`ï¼Œæˆ–è€…`overlap_len`å¤§äºæˆ–ç­‰äº`max_len`ï¼Œåˆ™å¼•å‘`ValueError`ã€‚

Type ç®—å­ç±»å‹: **mapper**

Tags æ ‡ç­¾: cpu, api, text

## ğŸ”§ Parameter Configuration å‚æ•°é…ç½®
| name å‚æ•°å | type ç±»å‹ | default é»˜è®¤å€¼ | desc è¯´æ˜ |
|--------|------|--------|------|
| `max_len` | typing.Optional[typing.Annotated[int, Gt(gt=0)]] | `None` | Split text into multi texts with this max len if not None. |
| `split_pattern` | typing.Optional[str] | `'\n\n'` | Make sure split in this pattern if it is not None and force cut if the length exceeds max_len. |
| `overlap_len` | typing.Annotated[int, Ge(ge=0)] | `0` | Overlap length of the split texts if not split in the split pattern. |
| `tokenizer` | typing.Optional[str] | `None` | The tokenizer name of Hugging Face tokenizers. The text length will be calculate as the token num if it is offered. Otherwise, the text length equals to string length. Support tiktoken tokenizer (such as gpt-4o), dashscope tokenizer ( such as qwen2.5-72b-instruct) and huggingface tokenizer. |
| `trust_remote_code` | <class 'bool'> | `False` | whether to trust the remote code of HF models. |
| `args` |  | `''` | extra args |
| `kwargs` |  | `''` | extra args |

## ğŸ“Š Effect demonstration æ•ˆæœæ¼”ç¤º
### test_naive_text_chunk
```python
TextChunkMapper(split_pattern='\n')
```

#### ğŸ“¥ input data è¾“å…¥æ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Today is Sunday and it&#x27;s a happy day!</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Sur la plateforme MT4, plusieurs maniÃ¨res d&#x27;accÃ©der Ã  
ces fonctionnalitÃ©s sont conÃ§ues simultanÃ©ment.</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">æ¬¢è¿æ¥åˆ°é˜¿é‡Œå·´å·´ï¼</pre></div>

#### ğŸ“¤ output data è¾“å‡ºæ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Today is Sunday and it&#x27;s a happy day!</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Sur la plateforme MT4, plusieurs maniÃ¨res d&#x27;accÃ©der Ã  </pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">ces fonctionnalitÃ©s sont conÃ§ues simultanÃ©ment.</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 4:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">æ¬¢è¿æ¥åˆ°é˜¿é‡Œå·´å·´ï¼</pre></div>

#### âœ¨ explanation è§£é‡Š
This example shows how the operator splits the input text into chunks based on a specified split pattern. Here, the split pattern is '\n', which means the text will be split at each newline character. In this case, only the second sample contains a newline, so it is split into two parts. The other samples do not contain newlines and remain unchanged.
è¿™ä¸ªä¾‹å­å±•ç¤ºäº†ç®—å­å¦‚ä½•æ ¹æ®æŒ‡å®šçš„åˆ†å‰²æ¨¡å¼å°†è¾“å…¥æ–‡æœ¬åˆ†å‰²æˆå¤šä¸ªå—ã€‚è¿™é‡Œï¼Œåˆ†å‰²æ¨¡å¼æ˜¯'\n'ï¼Œæ„å‘³ç€æ–‡æœ¬ä¼šåœ¨æ¯ä¸ªæ¢è¡Œç¬¦å¤„è¢«åˆ†å‰²ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªæœ‰ç¬¬äºŒä¸ªæ ·æœ¬åŒ…å«æ¢è¡Œç¬¦ï¼Œå› æ­¤å®ƒè¢«åˆ†æˆä¸¤éƒ¨åˆ†ã€‚å…¶ä»–æ ·æœ¬ä¸åŒ…å«æ¢è¡Œç¬¦ï¼Œæ‰€ä»¥ä¿æŒä¸å˜ã€‚

### test_max_len_text_chunk
```python
TextChunkMapper(max_len=20, split_pattern=None)
```

#### ğŸ“¥ input data è¾“å…¥æ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Today is Sunday and it&#x27;s a happy day!</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Sur la plateforme MT4, plusieurs maniÃ¨res d&#x27;accÃ©der Ã  ces fonctionnalitÃ©s sont conÃ§ues simultanÃ©ment.</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">æ¬¢è¿æ¥åˆ°é˜¿é‡Œå·´å·´ï¼</pre></div>

#### ğŸ“¤ output data è¾“å‡ºæ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Today is Sunday and </pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">it&#x27;s a happy day!</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">Sur la plateforme MT</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 4:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">4, plusieurs maniÃ¨re</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 5:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">s d&#x27;accÃ©der Ã  ces fo</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 6:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">nctionnalitÃ©s sont c</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 7:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">onÃ§ues simultanÃ©ment</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 8:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">.</pre></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 9:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">æ¬¢è¿æ¥åˆ°é˜¿é‡Œå·´å·´ï¼</pre></div>

#### âœ¨ explanation è§£é‡Š
This example demonstrates how the operator splits the input text into chunks with a maximum length of 20 characters. The text is split into multiple segments, each no longer than 20 characters. If a word or phrase is cut off, it is included in the next segment. This ensures that the text is divided into manageable pieces without breaking words in the middle.
è¿™ä¸ªä¾‹å­å±•ç¤ºäº†ç®—å­å¦‚ä½•å°†è¾“å…¥æ–‡æœ¬åˆ†å‰²æˆæœ€å¤§é•¿åº¦ä¸º20ä¸ªå­—ç¬¦çš„å¤šä¸ªå—ã€‚æ–‡æœ¬è¢«åˆ†å‰²æˆå¤šä¸ªæ®µï¼Œæ¯æ®µä¸è¶…è¿‡20ä¸ªå­—ç¬¦ã€‚å¦‚æœæŸä¸ªè¯æˆ–çŸ­è¯­è¢«æˆªæ–­ï¼Œå®ƒä¼šè¢«åŒ…å«åœ¨ä¸‹ä¸€æ®µä¸­ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿æ–‡æœ¬è¢«åˆ†å‰²æˆæ˜“äºå¤„ç†çš„éƒ¨åˆ†ï¼Œè€Œä¸ä¼šåœ¨ä¸­é—´æ‰“æ–­å•è¯ã€‚


## ğŸ”— related links ç›¸å…³é“¾æ¥
- [source code æºä»£ç ](../../../data_juicer/ops/mapper/text_chunk_mapper.py)
- [unit test å•å…ƒæµ‹è¯•](../../../tests/ops/mapper/test_text_chunk_mapper.py)
- [Return operator list è¿”å›ç®—å­åˆ—è¡¨](../../Operators.md)