# video_split_by_key_frame_mapper

Splits a video into segments based on key frames.

This operator processes video data by splitting it into multiple segments at key frame
boundaries. It uses the key frames to determine where to make the splits. The original
sample can be kept or discarded based on the `keep_original_sample` parameter. If
`save_dir` is specified, the split video files will be saved in that directory;
otherwise, they will be saved in the same directory as the input files. The operator
processes each video in the sample and updates the sample with the new video keys and
text placeholders. The `Fields.source_file` field is updated to reflect the new video
segments. This operator works in batch mode, processing multiple samples at once.

Type 算子类型: **mapper**

Tags 标签: cpu, multimodal

## 🔧 Parameter Configuration 参数配置
| name 参数名 | type 类型 | default 默认值 | desc 说明 |
|--------|------|--------|------|
| `keep_original_sample` | <class 'bool'> | `True` | whether to keep the original sample. If |
| `save_dir` | <class 'str'> | `None` | The directory where generated video files will be stored. |
| `args` |  | `''` | extra args |
| `kwargs` |  | `''` | extra args |

## 📊 Effect demonstration 效果演示
### test
```python
VideoSplitByKeyFrameMapper(keep_original_sample=False)
```

#### 📥 input data 输入数据
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; 白色的小羊站在一旁讲话。旁边还有两只灰色猫咪和一只拉着灰狼的猫咪。</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video1.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video1.mp4" controls width="320" style="margin:4px;"></video></div></div><details style='margin-top:6px;'><summary style='cursor:pointer;'>other key</summary><table style='border-collapse:collapse; margin-top:6px;'><tr><td style='padding:4px 8px; color:#555;'>id</td><td style='padding:4px 8px;'>0</td></tr></table></details></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; 身穿白色上衣的男子，拿着一个东西，拍打自己的胃部。&lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video2.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video2.mp4" controls width="320" style="margin:4px;"></video></div></div><details style='margin-top:6px;'><summary style='cursor:pointer;'>other key</summary><table style='border-collapse:collapse; margin-top:6px;'><tr><td style='padding:4px 8px; color:#555;'>id</td><td style='padding:4px 8px;'>1</td></tr></table></details></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; 两个长头发的女子正坐在一张圆桌前讲话互动。 &lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video3.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video3.mp4" controls width="320" style="margin:4px;"></video></div></div><details style='margin-top:6px;'><summary style='cursor:pointer;'>other key</summary><table style='border-collapse:collapse; margin-top:6px;'><tr><td style='padding:4px 8px; color:#555;'>id</td><td style='padding:4px 8px;'>2</td></tr></table></details></div>

#### 📤 output data 输出数据
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt;&lt;__dj__video&gt;&lt;__dj__video&gt; 白色的小羊站在一旁讲话。旁边还有两只灰色猫咪和一只拉着灰狼的猫咪。&lt;|__dj__eoc|&gt;</pre><details style='margin-top:6px;'><summary style='cursor:pointer;'>other key</summary><table style='border-collapse:collapse; margin-top:6px;'><tr><td style='padding:4px 8px; color:#555;'>id</td><td style='padding:4px 8px;'>0</td></tr><tr><td style='padding:4px 8px; color:#555;'>split_frames_num</td><td style='padding:4px 8px;'>[3]</td></tr></table></details></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt;&lt;__dj__video&gt;&lt;__dj__video&gt; 身穿白色上衣的男子，拿着一个东西，拍打自己的胃部。&lt;|__dj__eoc|&gt;</pre><details style='margin-top:6px;'><summary style='cursor:pointer;'>other key</summary><table style='border-collapse:collapse; margin-top:6px;'><tr><td style='padding:4px 8px; color:#555;'>id</td><td style='padding:4px 8px;'>1</td></tr><tr><td style='padding:4px 8px; color:#555;'>split_frames_num</td><td style='padding:4px 8px;'>[3]</td></tr></table></details></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt;&lt;__dj__video&gt;&lt;__dj__video&gt;&lt;__dj__video&gt;&lt;__dj__video&gt;&lt;__dj__video&gt; 两个长头发的女子正坐在一张圆桌前讲话互动。 &lt;|__dj__eoc|&gt;</pre><details style='margin-top:6px;'><summary style='cursor:pointer;'>other key</summary><table style='border-collapse:collapse; margin-top:6px;'><tr><td style='padding:4px 8px; color:#555;'>id</td><td style='padding:4px 8px;'>2</td></tr><tr><td style='padding:4px 8px; color:#555;'>split_frames_num</td><td style='padding:4px 8px;'>[6]</td></tr></table></details></div>

#### ✨ explanation 解释
The operator splits each video in the dataset into segments based on key frames and updates the text to reflect the number of split videos. The original sample is not kept, and only the new segments are included in the output. Each video is replaced with multiple video tokens in the text, and a 'split_frames_num' field is added to indicate how many segments were created from each video.
算子根据关键帧将数据集中的每个视频分割成多个片段，并更新文本以反映分割后的视频数量。原始样本不被保留，输出中只包含新的片段。每个视频在文本中被替换为多个视频标记，并添加一个'split_frames_num'字段来指示从每个视频创建了多少个片段。

### test_keep_ori_sample
```python
VideoSplitByKeyFrameMapper()
```

#### 📥 input data 输入数据
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; 白色的小羊站在一旁讲话。旁边还有两只灰色猫咪和一只拉着灰狼的猫咪。</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video1.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video1.mp4" controls width="320" style="margin:4px;"></video></div></div><details style='margin-top:6px;'><summary style='cursor:pointer;'>other key</summary><table style='border-collapse:collapse; margin-top:6px;'><tr><td style='padding:4px 8px; color:#555;'>id</td><td style='padding:4px 8px;'>0</td></tr></table></details></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; 身穿白色上衣的男子，拿着一个东西，拍打自己的胃部。&lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video2.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video2.mp4" controls width="320" style="margin:4px;"></video></div></div><details style='margin-top:6px;'><summary style='cursor:pointer;'>other key</summary><table style='border-collapse:collapse; margin-top:6px;'><tr><td style='padding:4px 8px; color:#555;'>id</td><td style='padding:4px 8px;'>1</td></tr></table></details></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; 两个长头发的女子正坐在一张圆桌前讲话互动。 &lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video3.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video3.mp4" controls width="320" style="margin:4px;"></video></div></div><details style='margin-top:6px;'><summary style='cursor:pointer;'>other key</summary><table style='border-collapse:collapse; margin-top:6px;'><tr><td style='padding:4px 8px; color:#555;'>id</td><td style='padding:4px 8px;'>2</td></tr></table></details></div>

#### 📤 output data 输出数据
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; 白色的小羊站在一旁讲话。旁边还有两只灰色猫咪和一只拉着灰狼的猫咪。</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video1.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video1.mp4" controls width="320" style="margin:4px;"></video></div></div><details style='margin-top:6px;'><summary style='cursor:pointer;'>other key</summary><table style='border-collapse:collapse; margin-top:6px;'><tr><td style='padding:4px 8px; color:#555;'>id</td><td style='padding:4px 8px;'>0</td></tr></table></details></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt;&lt;__dj__video&gt;&lt;__dj__video&gt; 白色的小羊站在一旁讲话。旁边还有两只灰色猫咪和一只拉着灰狼的猫咪。&lt;|__dj__eoc|&gt;</pre><details style='margin-top:6px;'><summary style='cursor:pointer;'>other key</summary><table style='border-collapse:collapse; margin-top:6px;'><tr><td style='padding:4px 8px; color:#555;'>id</td><td style='padding:4px 8px;'>0</td></tr><tr><td style='padding:4px 8px; color:#555;'>split_frames_num</td><td style='padding:4px 8px;'>[3]</td></tr></table></details></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; 身穿白色上衣的男子，拿着一个东西，拍打自己的胃部。&lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video2.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video2.mp4" controls width="320" style="margin:4px;"></video></div></div><details style='margin-top:6px;'><summary style='cursor:pointer;'>other key</summary><table style='border-collapse:collapse; margin-top:6px;'><tr><td style='padding:4px 8px; color:#555;'>id</td><td style='padding:4px 8px;'>1</td></tr></table></details></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 4:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt;&lt;__dj__video&gt;&lt;__dj__video&gt; 身穿白色上衣的男子，拿着一个东西，拍打自己的胃部。&lt;|__dj__eoc|&gt;</pre><details style='margin-top:6px;'><summary style='cursor:pointer;'>other key</summary><table style='border-collapse:collapse; margin-top:6px;'><tr><td style='padding:4px 8px; color:#555;'>id</td><td style='padding:4px 8px;'>1</td></tr><tr><td style='padding:4px 8px; color:#555;'>split_frames_num</td><td style='padding:4px 8px;'>[3]</td></tr></table></details></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 5:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; 两个长头发的女子正坐在一张圆桌前讲话互动。 &lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video3.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video3.mp4" controls width="320" style="margin:4px;"></video></div></div><details style='margin-top:6px;'><summary style='cursor:pointer;'>other key</summary><table style='border-collapse:collapse; margin-top:6px;'><tr><td style='padding:4px 8px; color:#555;'>id</td><td style='padding:4px 8px;'>2</td></tr></table></details></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 6:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt;&lt;__dj__video&gt;&lt;__dj__video&gt;&lt;__dj__video&gt;&lt;__dj__video&gt;&lt;__dj__video&gt; 两个长头发的女子正坐在一张圆桌前讲话互动。 &lt;|__dj__eoc|&gt;</pre><details style='margin-top:6px;'><summary style='cursor:pointer;'>other key</summary><table style='border-collapse:collapse; margin-top:6px;'><tr><td style='padding:4px 8px; color:#555;'>id</td><td style='padding:4px 8px;'>2</td></tr><tr><td style='padding:4px 8px; color:#555;'>split_frames_num</td><td style='padding:4px 8px;'>[6]</td></tr></table></details></div>

#### ✨ explanation 解释
The operator splits each video in the dataset into segments based on key frames but keeps the original sample as well. This means that for each input sample, there will be an additional entry in the output that includes the original unsplit video along with the new segments. The 'split_frames_num' field indicates the number of segments created from each video, and the original video is still present in the 'videos' field.
算子根据关键帧将数据集中的每个视频分割成多个片段，但同时保留了原始样本。这意味着对于每个输入样本，在输出中将有一个额外的条目，其中既包括未分割的原始视频，也包括新的片段。'split_frames_num'字段指示从每个视频创建了多少个片段，而原始视频仍然存在于'videos'字段中。


## 🔗 related links 相关链接
- [source code 源代码](../../../data_juicer/ops/mapper/video_split_by_key_frame_mapper.py)
- [unit test 单元测试](../../../tests/ops/mapper/test_video_split_by_key_frame_mapper.py)
- [Return operator list 返回算子列表](../../Operators.md)