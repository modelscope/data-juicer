# video_tagging_from_frames_mapper

Generates video tags from frames extracted from videos.

This operator extracts frames from videos and generates tags based on the content of these frames. The frame extraction method can be either "all_keyframes" or "uniform". For "all_keyframes", all keyframes are extracted, while for "uniform", a specified number of frames are extracted uniformly across the video. The tags are generated using a pre-trained model and stored in the specified field name. If the tags are already present in the sample, the operator skips processing. Important notes:
- Uses a Hugging Face tokenizer and a pre-trained model for tag generation.
- If no video is present in the sample, an empty tag array is stored.
- Frame tensors are processed to generate tags, which are then sorted by frequency and stored.

ä»è§†é¢‘ä¸­æå–çš„å¸§ç”Ÿæˆè§†é¢‘æ ‡ç­¾ã€‚

è¯¥ç®—å­ä»è§†é¢‘ä¸­æå–å¸§ï¼Œå¹¶æ ¹æ®è¿™äº›å¸§çš„å†…å®¹ç”Ÿæˆæ ‡ç­¾ã€‚å¸§æå–æ–¹æ³•å¯ä»¥æ˜¯ "all_keyframes" æˆ– "uniform"ã€‚å¯¹äº "all_keyframes"ï¼Œæå–æ‰€æœ‰å…³é”®å¸§ï¼Œè€Œå¯¹äº "uniform"ï¼Œåˆ™å‡åŒ€åœ°ä»è§†é¢‘ä¸­æå–æŒ‡å®šæ•°é‡çš„å¸§ã€‚æ ‡ç­¾ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹ç”Ÿæˆå¹¶å­˜å‚¨åœ¨æŒ‡å®šçš„å­—æ®µåç§°ä¸­ã€‚å¦‚æœæ ·æœ¬ä¸­å·²ç»å­˜åœ¨æ ‡ç­¾ï¼Œåˆ™è¯¥ç®—å­è·³è¿‡å¤„ç†ã€‚é‡è¦è¯´æ˜ï¼š
- ä½¿ç”¨ Hugging Face çš„åˆ†è¯å™¨å’Œé¢„è®­ç»ƒæ¨¡å‹ç”Ÿæˆæ ‡ç­¾ã€‚
- å¦‚æœæ ·æœ¬ä¸­æ²¡æœ‰è§†é¢‘ï¼Œåˆ™å­˜å‚¨ä¸€ä¸ªç©ºçš„æ ‡ç­¾æ•°ç»„ã€‚
- å¤„ç†å¸§å¼ é‡ä»¥ç”Ÿæˆæ ‡ç­¾ï¼Œç„¶åæŒ‰é¢‘ç‡æ’åºå¹¶å­˜å‚¨ã€‚

Type ç®—å­ç±»å‹: **mapper**

Tags æ ‡ç­¾: cpu, video

## ğŸ”§ Parameter Configuration å‚æ•°é…ç½®
| name å‚æ•°å | type ç±»å‹ | default é»˜è®¤å€¼ | desc è¯´æ˜ |
|--------|------|--------|------|
| `frame_sampling_method` | <class 'str'> | `'all_keyframes'` | sampling method of extracting frame images from the videos. Should be one of ["all_keyframes", "uniform"]. The former one extracts all key frames (the number of which depends on the duration of the video) and the latter one extract specified number of frames uniformly from the video. Default: "all_keyframes". |
| `frame_num` | typing.Annotated[int, Gt(gt=0)] | `3` | the number of frames to be extracted uniformly from the video. Only works when frame_sampling_method is "uniform". If it's 1, only the middle frame will be extracted. If it's 2, only the first and the last frames will be extracted. If it's larger than 2, in addition to the first and the last frames, other frames will be extracted uniformly within the video duration. |
| `tag_field_name` | <class 'str'> | `'video_frame_tags'` | the field name to store the tags. It's "video_frame_tags" in default. |
| `args` |  | `''` | extra args |
| `kwargs` |  | `''` | extra args |

## ğŸ“Š Effect demonstration æ•ˆæœæ¼”ç¤º
### test
```python
VideoTaggingFromFramesMapper()
```

#### ğŸ“¥ input data è¾“å…¥æ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; ç™½è‰²çš„å°ç¾Šç«™åœ¨ä¸€æ—è®²è¯ã€‚æ—è¾¹è¿˜æœ‰ä¸¤åªç°è‰²çŒ«å’ªå’Œä¸€åªæ‹‰ç€ç°ç‹¼çš„çŒ«å’ªã€‚</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video1.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video1.mp4" controls width="320" style="margin:4px;"></video></div></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; èº«ç©¿ç™½è‰²ä¸Šè¡£çš„ç”·å­ï¼Œæ‹¿ç€ä¸€ä¸ªä¸œè¥¿ï¼Œæ‹æ‰“è‡ªå·±çš„èƒƒéƒ¨ã€‚&lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video2.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video2.mp4" controls width="320" style="margin:4px;"></video></div></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; ä¸¤ä¸ªé•¿å¤´å‘çš„å¥³å­æ­£ååœ¨ä¸€å¼ åœ†æ¡Œå‰è®²è¯äº’åŠ¨ã€‚ &lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video3.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video3.mp4" controls width="320" style="margin:4px;"></video></div></div></div>

#### ğŸ“¤ output data è¾“å‡ºæ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; ç™½è‰²çš„å°ç¾Šç«™åœ¨ä¸€æ—è®²è¯ã€‚æ—è¾¹è¿˜æœ‰ä¸¤åªç°è‰²çŒ«å’ªå’Œä¸€åªæ‹‰ç€ç°ç‹¼çš„çŒ«å’ªã€‚</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video1.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video1.mp4" controls width="320" style="margin:4px;"></video></div></div><div class='meta' style='margin:6px 0;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #e3e3e3;'><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>__dj__meta__</th></tr><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; font-weight:500; color:#444; border-bottom:1px solid #e3e3e3; white-space:nowrap;'>video_frame_tags</td><td style='text-align:left; vertical-align:top; padding:4px 6px; padding-left:4px; border-bottom:1px solid #e3e3e3;'>[[&#x27;animal&#x27;, &#x27;ray&#x27;, &#x27;text&#x27;, &#x27;writing&#x27;, &#x27;yellow&#x27;, &#x27;game&#x27;, &#x27;screenshot&#x27;, &#x27;cartoon&#x27;, &#x27;cartoon character&#x27;, &#x27;person&#x27;, &#x27;robe&#x27;, &#x27;sky&#x27;]]</td></tr></table></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; èº«ç©¿ç™½è‰²ä¸Šè¡£çš„ç”·å­ï¼Œæ‹¿ç€ä¸€ä¸ªä¸œè¥¿ï¼Œæ‹æ‰“è‡ªå·±çš„èƒƒéƒ¨ã€‚&lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video2.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video2.mp4" controls width="320" style="margin:4px;"></video></div></div><div class='meta' style='margin:6px 0;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #e3e3e3;'><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>__dj__meta__</th></tr><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; font-weight:500; color:#444; border-bottom:1px solid #e3e3e3; white-space:nowrap;'>video_frame_tags</td><td style='text-align:left; vertical-align:top; padding:4px 6px; padding-left:4px; border-bottom:1px solid #e3e3e3;'>[[&#x27;man&#x27;, &#x27;shirt&#x27;, &#x27;t shirt&#x27;, &#x27;t-shirt&#x27;, &#x27;wear&#x27;, &#x27;white&#x27;, &#x27;boy&#x27;, &#x27;catch&#x27;, &#x27;hand&#x27;, &#x27;blind&#x27;, &#x27;cotton candy&#x27;, &#x27;tennis racket&#x27;, &#x27;ball&#x27;, &#x27;person&#x27;]]</td></tr></table></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 3:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; ä¸¤ä¸ªé•¿å¤´å‘çš„å¥³å­æ­£ååœ¨ä¸€å¼ åœ†æ¡Œå‰è®²è¯äº’åŠ¨ã€‚ &lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video3.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video3.mp4" controls width="320" style="margin:4px;"></video></div></div><div class='meta' style='margin:6px 0;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #e3e3e3;'><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>__dj__meta__</th></tr><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; font-weight:500; color:#444; border-bottom:1px solid #e3e3e3; white-space:nowrap;'>video_frame_tags</td><td style='text-align:left; vertical-align:top; padding:4px 6px; padding-left:4px; border-bottom:1px solid #e3e3e3;'>[[&#x27;woman&#x27;, &#x27;table&#x27;, &#x27;sit&#x27;, &#x27;person&#x27;, &#x27;laptop&#x27;, &#x27;bookshelf&#x27;, &#x27;conversation&#x27;, &#x27;round table&#x27;, &#x27;closet&#x27;, &#x27;computer&#x27;, &#x27;girl&#x27;, &#x27;man&#x27;, &#x27;stool&#x27;, &#x27;computer screen&#x27;, &#x27;laugh&#x27;, &#x27;cabinet&#x27;, &#x27;hand&#x27;, &#x27;selfie&#x27;, &#x27;stand&#x27;]]</td></tr></table></div></div>

#### âœ¨ explanation è§£é‡Š
This example demonstrates the typical use of the operator, where it extracts frames from videos and generates tags based on the content. The tags are then stored in the 'meta' field under the key 'video_frame_tags'. Each video in the input has a corresponding list of tags that describe its content, such as 'animal', 'man', or 'woman'.
æ­¤ç¤ºä¾‹å±•ç¤ºäº†ç®—å­çš„å…¸å‹ç”¨æ³•ï¼Œå®ƒä»è§†é¢‘ä¸­æå–å¸§å¹¶æ ¹æ®å†…å®¹ç”Ÿæˆæ ‡ç­¾ã€‚è¿™äº›æ ‡ç­¾éšåå­˜å‚¨åœ¨'meta'å­—æ®µä¸‹çš„'video_frame_tags'é”®ä¸­ã€‚è¾“å…¥ä¸­çš„æ¯ä¸ªè§†é¢‘éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„æ ‡ç­¾åˆ—è¡¨æ¥æè¿°å…¶å†…å®¹ï¼Œä¾‹å¦‚'åŠ¨ç‰©'ã€'ç”·å­'æˆ–'å¥³å­'ã€‚

### test_no_video
```python
VideoTaggingFromFramesMapper()
```

#### ğŸ“¥ input data è¾“å…¥æ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">ç™½è‰²çš„å°ç¾Šç«™åœ¨ä¸€æ—è®²è¯ã€‚æ—è¾¹è¿˜æœ‰ä¸¤åªç°è‰²çŒ«å’ªå’Œä¸€åªæ‹‰ç€ç°ç‹¼çš„çŒ«å’ªã€‚</pre><div class='meta' style='margin:6px 0;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #e3e3e3;'><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>videos</th></tr></table></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; èº«ç©¿ç™½è‰²ä¸Šè¡£çš„ç”·å­ï¼Œæ‹¿ç€ä¸€ä¸ªä¸œè¥¿ï¼Œæ‹æ‰“è‡ªå·±çš„èƒƒéƒ¨ã€‚&lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video2.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video2.mp4" controls width="320" style="margin:4px;"></video></div></div></div>

#### ğŸ“¤ output data è¾“å‡ºæ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> text</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">ç™½è‰²çš„å°ç¾Šç«™åœ¨ä¸€æ—è®²è¯ã€‚æ—è¾¹è¿˜æœ‰ä¸¤åªç°è‰²çŒ«å’ªå’Œä¸€åªæ‹‰ç€ç°ç‹¼çš„çŒ«å’ªã€‚</pre><div class='meta' style='margin:6px 0;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #e3e3e3;'><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>videos</th></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>__dj__meta__</th></tr><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; font-weight:500; color:#444; border-bottom:1px solid #e3e3e3; white-space:nowrap;'>video_frame_tags</td><td style='text-align:left; vertical-align:top; padding:4px 6px; padding-left:4px; border-bottom:1px solid #e3e3e3;'>[[]]</td></tr></table></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> text | 1 video</div><pre style="padding:6px; background:#f6f8fa; border-radius:4px; overflow-x:auto; white-space:pre; word-wrap:normal;">&lt;__dj__video&gt; èº«ç©¿ç™½è‰²ä¸Šè¡£çš„ç”·å­ï¼Œæ‹¿ç€ä¸€ä¸ªä¸œè¥¿ï¼Œæ‹æ‰“è‡ªå·±çš„èƒƒéƒ¨ã€‚&lt;|__dj__eoc|&gt;</pre><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video2.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video2.mp4" controls width="320" style="margin:4px;"></video></div></div><div class='meta' style='margin:6px 0;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #e3e3e3;'><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>__dj__meta__</th></tr><tr><td style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; font-weight:500; color:#444; border-bottom:1px solid #e3e3e3; white-space:nowrap;'>video_frame_tags</td><td style='text-align:left; vertical-align:top; padding:4px 6px; padding-left:4px; border-bottom:1px solid #e3e3e3;'>[[&#x27;man&#x27;, &#x27;shirt&#x27;, &#x27;t shirt&#x27;, &#x27;t-shirt&#x27;, &#x27;wear&#x27;, &#x27;white&#x27;, &#x27;boy&#x27;, &#x27;catch&#x27;, &#x27;hand&#x27;, &#x27;blind&#x27;, &#x27;cotton candy&#x27;, &#x27;tennis racket&#x27;, &#x27;ball&#x27;, &#x27;person&#x27;]]</td></tr></table></div></div>

#### âœ¨ explanation è§£é‡Š
This example illustrates an important edge case: when there is no video in the sample, the operator still adds an empty tag array to the 'meta' field. This ensures consistency in the data structure, even for samples without videos. For the sample with a video, the operator works as expected, generating and storing relevant tags.
æ­¤ç¤ºä¾‹è¯´æ˜äº†ä¸€ä¸ªé‡è¦çš„è¾¹ç¼˜æƒ…å†µï¼šå½“æ ·æœ¬ä¸­æ²¡æœ‰è§†é¢‘æ—¶ï¼Œç®—å­ä»ç„¶ä¼šåœ¨'meta'å­—æ®µä¸­æ·»åŠ ä¸€ä¸ªç©ºçš„æ ‡ç­¾æ•°ç»„ã€‚è¿™ç¡®ä¿äº†å³ä½¿å¯¹äºæ²¡æœ‰è§†é¢‘çš„æ ·æœ¬ï¼Œæ•°æ®ç»“æ„ä¹Ÿä¿æŒä¸€è‡´ã€‚å¯¹äºåŒ…å«è§†é¢‘çš„æ ·æœ¬ï¼Œç®—å­æŒ‰é¢„æœŸå·¥ä½œï¼Œç”Ÿæˆå¹¶å­˜å‚¨ç›¸å…³æ ‡ç­¾ã€‚


## ğŸ”— related links ç›¸å…³é“¾æ¥
- [source code æºä»£ç ](../../../data_juicer/ops/mapper/video_tagging_from_frames_mapper.py)
- [unit test å•å…ƒæµ‹è¯•](../../../tests/ops/mapper/test_video_tagging_from_frames_mapper.py)
- [Return operator list è¿”å›ç®—å­åˆ—è¡¨](../../Operators.md)